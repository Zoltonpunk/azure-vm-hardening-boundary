# Azure VM Hardening with Boundary and Apache Reverse Proxy

## Overview

This project automates the creation of a hardened Ubuntu 22.04 VM image using Packer, configures HashiCorp Boundary for secure remote access, and protects the Boundary API using Apache as a reverse proxy with TLS.

The hardened image includes CIS Level 1 hardening with OpenSCAP, a custom firewall using iptables (netfilter), and a dummy local HTTPS web server to demonstrate secure target access.

---

## Contents

```
├── packer/                      # Packer templates and scripts
│   ├── templates/               # Packer HCL files
│   └── scripts/                 # Hardening, TLS cert generation, Azure agent removal
├── boundary/                    # Boundary configuration and setup scripts
├── netfilter/                   # iptables rules for firewall
├── docs/                        # Setup instructions
└── README.md                    # This file
```

---

## Packer Image Build

- Uses `ubuntu2204-azure.pkr.hcl` as the main build template.
- Applies CIS Level 1 hardening using OpenSCAP.
- Removes the Azure Linux Agent to reduce the attack surface.
- Installs Apache and generates a self-signed TLS certificate.

### OpenSCAP Reports

The build process creates OpenSCAP evaluation reports:

- Before hardening: `../pre_hardening_results.xml`
- After hardening:  `../post_hardening_results.xml`

### OpenSCAP Hardening Exceptions

The following rules were skipped due to practicality or conflicts:

- `xccdf_org.ssgproject.content_rule_disable_ctrlaltdel_burst`: not relevant for VM environments.
- `xccdf_org.ssgproject.content_rule_disable_host_authentication`: redundant with SSH key enforcement.
- `xccdf_org.ssgproject.content_rule_no_direct_root_logins`: enforced via SSH configs.

These skips are justified by operational context and do not reduce overall compliance significantly.

### Azure Agent Removal and Boot

The `walinuxagent` is removed using `remove-azure-agent.sh`. Boot validation is ensured by:

- Setting up necessary SSH keys at build time.
- Using serial console access for VM recovery if required.
- Avoiding dynamic provisioning during startup.

---

## Boundary Setup

- Single VM installation (controller + worker on same instance).
- Configured via `boundary.hcl` and installation scripts.
- Local dummy HTTPS web server (on `localhost`) acts as Boundary target.

### Apache Reverse Proxy

- Apache is used to protect the Boundary API endpoint.
- TLS is enforced using a 4096-bit self-signed certificate generated by `generate_cert.sh`.
- The FQDN `boundary.local` is used throughout the setup.

---

## Netfilter (Firewall)

Firewall rules are applied via `netfilter/apply_rules.sh`:

- Only allows necessary local traffic.
- Blocks all other inbound connections.
- Ensures that only HTTPS/API/Boundary services are exposed.

---

## Security Architecture and Justifications

```
[User Terminal]
     |
     | HTTPS + Password Auth
     v
[Apache Reverse Proxy] ---> [Boundary (controller + worker)]
                                  |
                                  v
                       [localhost Apache dummy HTTPS]
```

- **Apache Reverse Proxy**: Controls and secures all inbound access.
- **Boundary**: Manages access control and session handling.
- **TLS**: Ensures encrypted communication using modern standards.
- **Firewall**: Enforces least privilege network access.

---

## Usage

See `docs/quickstart.md` for detailed steps on how to build the image, launch the VM, and test the full setup locally.

---

## Author

This setup was created for the IT Security Engineering Practical Assessment. Feedback and suggestions welcome!
